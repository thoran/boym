#!/usr/bin/env ruby
# payslip

# 20150909, 10, 11
# 0.1.0

require 'active_record'

require_relative '../lib/SimpleCSV.rbd/SimpleCSV'
require_relative '../lib/employee'
require_relative '../lib/employee_file'
require_relative '../lib/employee_tax'
require_relative '../lib/payslip'
require_relative '../lib/tax_table'

TAX_TABLE_FILE = File.expand_path(File.join('..', '..', 'data', 'tax_table.csv'), __FILE__)
EMPLOYEE_FILE = File.expand_path(File.join('..', '..', 'data', 'input.csv'), __FILE__)
PAYSLIP_FILE = File.expand_path(File.join('..', '..', 'data', 'output.csv'), __FILE__)

def load_tax_table
  @tax_table ||= TaxTable.load(TAX_TABLE_FILE)
end

def employees
  employees = Employee.load(EMPLOYEE_FILE)
  raise employees if employees.any?{|e| e.errors.present?}
end

def calculate_employees_taxes(tax_table)
  employees.collect{|employee| EmployeeTax.new(employee, tax_table)}
end

def generate_payslip(employees_taxes)
  Payslip.new(employees_taxes).dump(PAYSLIP_FILE)
end

def main
  tax_table = load_tax_table
  employees_taxes = calculate_employees_taxes(tax_table)
  generate_payslip(employees_taxes)
end

main
